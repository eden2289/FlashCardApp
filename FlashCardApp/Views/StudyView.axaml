<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:FlashCardApp.ViewModels"
             xmlns:controls="using:FlashCardApp.Controls"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="FlashCardApp.Views.StudyView"
             x:DataType="vm:StudyViewModel"
             Background="#121212">
    
    <Design.DataContext>
        <vm:StudyViewModel />
    </Design.DataContext>

    <Grid>
        <!-- Layer 1: Background -->
        <Border Background="#0A0A0A"/>
        
        <!-- Main Content -->
        <Grid RowDefinitions="Auto,*,Auto" Margin="20">
            
            <!-- Top Bar -->
            <Grid Grid.Row="0" ColumnDefinitions="Auto,*,Auto" Margin="0,0,0,20">
                <!-- Back/Abort Button -->
                <Button Grid.Column="0"
                        Command="{Binding AbortCommand}"
                        Padding="12,8"
                        Background="Transparent"
                        BorderBrush="#666666"
                        BorderThickness="1"
                        CornerRadius="6"
                        Cursor="Hand">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="âœ•" FontSize="16" Foreground="#A0A0A0"/>
                        <TextBlock Text="çµæŸ" FontSize="14" Foreground="#A0A0A0"/>
                    </StackPanel>
                </Button>
                
                <!-- Progress Info -->
                <StackPanel Grid.Column="1" 
                            HorizontalAlignment="Center" 
                            VerticalAlignment="Center">
                    <TextBlock Text="{Binding Progress}" 
                               FontSize="18" 
                               FontWeight="SemiBold"
                               Foreground="White"
                               HorizontalAlignment="Center"/>
                    <TextBlock Text="{Binding RoundInfo}" 
                               FontSize="14" 
                               Foreground="#A0A0A0"
                               HorizontalAlignment="Center"/>
                </StackPanel>
                
                <!-- Undo Button - Always visible, styled when disabled -->
                <Button Grid.Column="2"
                        Command="{Binding UndoCommand}"
                        IsEnabled="{Binding CanUndo}"
                        Padding="12,8"
                        Background="Transparent"
                        BorderThickness="1"
                        CornerRadius="6"
                        Cursor="Hand">
                    <Button.Styles>
                        <Style Selector="Button:disabled">
                            <Setter Property="Opacity" Value="0.35"/>
                            <Setter Property="BorderBrush" Value="#805A3E"/>
                        </Style>
                        <Style Selector="Button:not(:disabled)">
                            <Setter Property="BorderBrush" Value="#FFA000"/>
                        </Style>
                    </Button.Styles>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="â†©" FontSize="16" Foreground="#FFA000"/>
                        <TextBlock Text="å¾©åŽŸ" FontSize="14" Foreground="#FFA000"/>
                    </StackPanel>
                </Button>
            </Grid>
            
            <!-- Layer 2: Card Area -->
            <Grid Grid.Row="1">
                <!-- Review Missed Cards Banner -->
                <Border IsVisible="{Binding IsReviewingMissed}"
                        Background="#FFA000"
                        CornerRadius="8"
                        Padding="12,8"
                        VerticalAlignment="Top"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,20"
                        ZIndex="10">
                    <TextBlock Text="ðŸ“š è¤‡ç¿’éŒ¯èª¤å¡ç‰‡ä¸­..."
                               FontSize="14"
                               FontWeight="SemiBold"
                               Foreground="White"/>
                </Border>
                
                <!-- Small counters at edges -->
                <!-- Unknown count (Left edge, 1/3 from top) -->
                <Border Background="#1A1A1A"
                        BorderBrush="#F44336"
                        BorderThickness="1"
                        CornerRadius="6"
                        Padding="8,4"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        Margin="12,120,0,0">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="âœ—"
                                   FontSize="12"
                                   Foreground="#F44336"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding UnknownCount}"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   Foreground="#F44336"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>
                
                <!-- Known count (Right edge, 1/3 from top) -->
                <Border Background="#1A1A1A"
                        BorderBrush="#4CAF50"
                        BorderThickness="1"
                        CornerRadius="6"
                        Padding="8,4"
                        HorizontalAlignment="Right"
                        VerticalAlignment="Top"
                        Margin="0,120,12,0">
                    <StackPanel Orientation="Horizontal" Spacing="4">
                        <TextBlock Text="âœ“"
                                   FontSize="12"
                                   Foreground="#4CAF50"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding KnownCount}"
                                   FontSize="14"
                                   FontWeight="SemiBold"
                                   Foreground="#4CAF50"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>
                
                <!-- Card Stack Container - Center -->
                <Grid HorizontalAlignment="Center"
                      VerticalAlignment="Center"
                      Width="370"
                      Height="480">
                    
                    <!-- Third Card (Bottom of stack - darkest, smallest) -->
                    <Border IsVisible="{Binding ThirdCard, Converter={x:Static ObjectConverters.IsNotNull}}"
                            Background="#101010"
                            BorderBrush="#333333"
                            BorderThickness="1"
                            CornerRadius="16"
                            Width="310"
                            Height="400"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Opacity="0.4"
                            Margin="0,0,0,0">
                        <Border.RenderTransform>
                            <TranslateTransform Y="16"/>
                        </Border.RenderTransform>
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                            <TextBlock Text="è©žèªž"
                                       FontSize="12"
                                       Foreground="#555555"
                                       HorizontalAlignment="Center"
                                       Margin="0,0,0,8"/>
                            <TextBlock Text="{Binding ThirdCard.Front}"
                                       FontSize="18"
                                       Foreground="#666666"
                                       HorizontalAlignment="Center"
                                       TextWrapping="Wrap"
                                       MaxWidth="260"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- Second Card (Middle of stack - medium dark) -->
                    <Border IsVisible="{Binding UpcomingCard, Converter={x:Static ObjectConverters.IsNotNull}}"
                            Background="#151515"
                            BorderBrush="#444444"
                            BorderThickness="1"
                            CornerRadius="16"
                            Width="330"
                            Height="420"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Opacity="0.7"
                            Margin="0,0,0,0">
                        <Border.RenderTransform>
                            <TranslateTransform Y="8"/>
                        </Border.RenderTransform>
                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                            <TextBlock Text="è©žèªž"
                                       FontSize="12"
                                       Foreground="#777777"
                                       HorizontalAlignment="Center"
                                       Margin="0,0,0,8"/>
                            <TextBlock Text="{Binding UpcomingCard.Front}"
                                       FontSize="20"
                                       Foreground="#999999"
                                       HorizontalAlignment="Center"
                                       TextWrapping="Wrap"
                                       MaxWidth="280"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- Current Card (Top of stack - brightest, full size) -->
                    <Border x:Name="CardContainer"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center"
                            Width="350"
                            Height="450"
                            PointerPressed="CardContainer_PointerPressed"
                            PointerMoved="CardContainer_PointerMoved"
                            PointerReleased="CardContainer_PointerReleased"
                            Cursor="Hand">
                        
                        <Grid>
                            <!-- Known Overlay (Green) -->
                            <Border x:Name="KnownOverlay"
                                    Background="#4CAF50"
                                    CornerRadius="16"
                                    Opacity="0"
                                    ZIndex="5"/>
                            
                            <!-- Unknown Overlay (Red) -->
                            <Border x:Name="UnknownOverlay"
                                    Background="#F44336"
                                    CornerRadius="16"
                                    Opacity="0"
                                    ZIndex="5"/>
                            
                            <!-- FlipCard Control for 3D Animation -->
                            <controls:FlipCard x:Name="StudyFlipCard"
                                               FrontText="{Binding CurrentCard.Front}"
                                               BackText="{Binding CurrentCard.Back}"
                                               IsInteractive="False"
                                               IsVisible="{Binding CurrentCard, Converter={x:Static ObjectConverters.IsNotNull}}"
                                               HorizontalAlignment="Stretch"
                                               VerticalAlignment="Stretch"/>
                            
                            <!-- No Card State -->
                            <Border IsVisible="{Binding CurrentCard, Converter={x:Static ObjectConverters.IsNull}}"
                                    Background="#1E1E1E"
                                    CornerRadius="16"
                                    Padding="40">
                                <TextBlock Text="è¼‰å…¥ä¸­..."
                                           FontSize="20"
                                           Foreground="#666666"
                                           HorizontalAlignment="Center"
                                           VerticalAlignment="Center"/>
                            </Border>
                        </Grid>
                    </Border>
                </Grid>
            </Grid>
            
            <!-- Layer 3: Bottom Controls -->
            <StackPanel Grid.Row="2" 
                        VerticalAlignment="Center"
                        HorizontalAlignment="Center"
                        Margin="0,20,0,0">
                <TextBlock Text="é»žæ“Šå¡ç‰‡ç¿»è½‰"
                           FontSize="14"
                           Foreground="#666666"
                           HorizontalAlignment="Center"/>
                <TextBlock Text="â† å‘å·¦æ»‘å‹•: ä¸èªè­˜  |  å‘å³æ»‘å‹•: èªè­˜ â†’"
                           FontSize="14"
                           Foreground="#666666"
                           HorizontalAlignment="Center"
                           Margin="0,8,0,0"/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
